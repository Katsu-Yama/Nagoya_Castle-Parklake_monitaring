<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>貯水池藻類監視ダッシュボード（試作：画像切替＋CSVグラフ）</title>

  <!-- Chart.js (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    :root {
      --bg: #f5f7fb;
      --card: #ffffff;
      --border: #e5e7eb;
      --text: #0f172a;
      --muted: #64748b;
      --blue: #2563eb;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
      color: var(--text);
      background: var(--bg);
    }
    header {
      background: linear-gradient(90deg, #1d4ed8, #2563eb);
      color: #fff;
      padding: 14px 18px;
    }
    header .title { font-weight: 700; font-size: 18px; }
    header .sub { font-size: 12px; opacity: .9; margin-top: 2px; }
    .wrap {
      max-width: 1280px;
      margin: 0 auto;
      padding: 14px;
    }
    .grid {
      display: grid;
      grid-template-columns: 260px 1fr 460px;
      gap: 12px;
      align-items: start;
    }
    @media (max-width: 1100px) {
      .grid { grid-template-columns: 1fr; }
    }
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }
    .section-title {
      font-weight: 700;
      margin: 0 0 10px 0;
      font-size: 14px;
    }

    /* left list */
    .reservoir-item {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 10px;
      background: #fff;
    }
    .reservoir-item.selected {
      outline: 2px solid rgba(37,99,235,.25);
      border-color: rgba(37,99,235,.45);
    }
    .reservoir-top {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: baseline;
    }
    .badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
      background: #f8fafc;
      white-space: nowrap;
    }
    .badge.ok { color: #166534; background: #f0fdf4; border-color: #bbf7d0; }
    .badge.nodata { color: #475569; background: #f1f5f9; border-color: #e2e8f0; }
    .muted { color: var(--muted); font-size: 12px; }
    .note {
      font-size: 11px;
      color: var(--muted);
      line-height: 1.5;
    }

    /* center: single image viewer */
    .viewer {
      display: grid;
      grid-template-rows: auto auto auto;
      gap: 10px;
    }
    .viewer-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: space-between;
    }
    .viewer-left {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }
    .btn {
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
      font-size: 12px;
      line-height: 1;
    }
    .btn:hover { border-color: rgba(37,99,235,.35); }
    .btn.primary {
      background: rgba(37,99,235,.08);
      border-color: rgba(37,99,235,.35);
      color: #1d4ed8;
      font-weight: 700;
    }
    .pill {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--muted);
    }
    .viewer-imgwrap {
      display: flex;
      justify-content: center;
    }
    .viewer-img {
      width: 70%;
      height: auto;
      border: 1px solid var(--border);
      border-radius: 10px;
      background: #fff;
    }
    @media (max-width: 1100px) {
      .viewer-img { width: 100%; }
    }

    /* right: KPIs + charts */
    .kpi-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 10px;
    }
    .kpi {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      background: #fff;
      min-height: 68px;
    }
    .kpi .label { font-size: 11px; color: var(--muted); }
    .kpi .value { font-size: 16px; font-weight: 800; margin-top: 4px; }
    .kpi .date { font-size: 10px; color: var(--muted); margin-top: 2px; }

    .chart-card {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px;
      background: #fff;
      margin-bottom: 10px;
    }
    .chart-title {
      font-size: 12px;
      font-weight: 700;
      margin: 0 0 6px 0;
    }
    canvas { width: 100% !important; height: 220px !important; }
    .select-row {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-bottom: 6px;
    }
    .select-row select {
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid var(--border);
      font-size: 12px;
    }
  </style>
</head>

<body>
  <header>
    <div class="title">貯水池藻類監視ダッシュボード（試作版）</div>
    <div class="sub">画像は切替表示、時系列はCSVを読み込みブラウザで描画（GitHub Pages想定）</div>
  </header>

  <div class="wrap">
    <div class="grid">
      <!-- Left -->
      <aside class="card">
        <div class="section-title">箇所一覧</div>
        <div id="locationList"></div>
        <div class="note">
          ※ 左の箇所名を選ぶと、画像・グラフが切り替わります。
        </div>
      </aside>

      <!-- Center -->
      <main class="card">
        <div class="section-title">NDCI（水域のみ）画像ビューア</div>

        <div class="viewer">
          <div class="viewer-toolbar">
            <div class="viewer-left">
              <button class="btn primary" id="btnFirst" title="一番上（最新）へ">⏮</button>
              <button class="btn" id="btnPrev" title="一つ上（新しい方向）">▲</button>
              <button class="btn" id="btnNext" title="一つ下（古い方向）">▼</button>

              <label class="pill">
                日付選択：
                <input id="datePicker" type="date" style="border:none; outline:none; font:inherit; color:inherit; background:transparent;">
              </label>
            </div>

            <div class="pill" id="imgLabel">表示中：—</div>
          </div>

          <div class="viewer-imgwrap">
            <img id="ndciImg" class="viewer-img" alt="NDCI image" />
          </div>

          <div class="note">
            ※ 日付選択は「その日付に最も近い画像」を表示します。<br/>
            ※ 画像・CSVは GitHub Pages で配信できる場所（例：<code>./Nagoya_castle/</code>）に置いてください。
          </div>
        </div>
      </main>

      <!-- Right -->
      <section class="card">
        <div class="section-title">最新値（CSVの最新行 / loess）</div>

        <div class="kpi-row">
          <div class="kpi">
            <div class="label">NDCI_mean_loess</div>
            <div class="value" id="kpiNdci">—</div>
            <div class="date" id="kpiDate">latest: —</div>
          </div>
          <div class="kpi">
            <div class="label">NDTI_mean_loess</div>
            <div class="value" id="kpiNdti">—</div>
            <div class="date" id="kpiDate2">latest: —</div>
          </div>
          <div class="kpi">
            <div class="label">FAI_mean_loess</div>
            <div class="value" id="kpiFai">—</div>
            <div class="date" id="kpiDate3">latest: —</div>
          </div>
        </div>

        <div class="section-title">時系列（CSVからブラウザで描画 / loess）</div>

        <div class="chart-card">
          <div class="chart-title">藻類量proxy（NDCI_mean_loess）</div>
          <canvas id="chartNdci"></canvas>
        </div>

        <div class="chart-card">
          <div class="chart-title">濁度proxy（NDTI_mean_loess）</div>
          <canvas id="chartNdti"></canvas>
        </div>

        <div class="chart-card">
          <div class="chart-title">浮遊藻類proxy（FAI_mean_loess）</div>
          <canvas id="chartFai"></canvas>
        </div>

        <div class="chart-card" style="margin-bottom:0;">
          <div class="chart-title">loess + 実測値（選択）</div>
          <div class="select-row">
            <label for="metricSelect" class="muted">表示項目</label>
            <select id="metricSelect">
              <option value="NDCI">NDCI</option>
              <option value="NDTI">NDTI</option>
              <option value="FAI">FAI</option>
            </select>
          </div>
          <canvas id="chartSelected"></canvas>
        </div>

        <div class="note" style="margin-top:8px;">
          ※ グラフはCSVを fetch するため、ローカルファイル直開きだと動かない場合があります。GitHub Pages 上で動作します。
        </div>
      </section>
    </div>
  </div>

  <script>
    // =========================
    // GitHub Pages配置前提のパス
    // - 画像/CSVは repo の各ディレクトリ配下に置く
    //   例: https://<user>.github.io/<repo>/Nagoya_castle/images/xxxx.png
    // =========================
    const LOCATIONS = [
      {
        id: "Nagoya_castle",
        label: "Nagoya_castle",
        images: [
          "ndci_2025-12-05.png",
          "ndci_2025-12-10.png",
          "ndci_2025-12-15.png",
          "ndci_2025-12-17.png"
        ]
      },
      {
        id: "MeijouPark",
        label: "MeijouPark",
        images: [
          "ndci_2025-11-30.png",
          "ndci_2025-12-05.png",
          "ndci_2025-12-10.png",
          "ndci_2025-12-15.png"
        ]
      },
      {
        id: "TsurumaPark",
        label: "TsurumaPark",
        images: [
          "ndci_2025-11-30.png",
          "ndci_2025-12-05.png",
          "ndci_2025-12-10.png",
          "ndci_2025-12-15.png"
        ]
      }
    ];

    // --- Image viewer state ---
    let currentIndex = 0; // 0 = 最新（先頭）
    let currentLocation = LOCATIONS[0];
    let currentImages = [];

    const elImg = document.getElementById("ndciImg");
    const elLabel = document.getElementById("imgLabel");
    const elDatePicker = document.getElementById("datePicker");

    function setImageByIndex(idx) {
      if (!currentImages.length) {
        elImg.removeAttribute("src");
        elLabel.textContent = "表示中：画像なし";
        elDatePicker.value = "";
        return;
      }
      if (idx < 0) idx = 0;
      if (idx > currentImages.length - 1) idx = currentImages.length - 1;
      currentIndex = idx;

      const it = currentImages[currentIndex];
      elImg.src = `${currentLocation.id}/images/${it.file}`;
      elImg.alt = `NDCI ${currentLocation.label} ${it.date}`;
      elLabel.textContent = `表示中：${currentLocation.label} / ${it.date}（${currentIndex + 1}/${currentImages.length}）`;

      // datePickerは "表示画像の日付" に合わせる（ユーザー選択の近傍にスナップする挙動が直感的）
      elDatePicker.value = it.date;
    }

    function dateToNum(d) { // "YYYY-MM-DD" -> milliseconds
      const t = new Date(d + "T00:00:00");
      return t.getTime();
    }

    function setImageByNearestDate(targetDateStr) {
      const target = dateToNum(targetDateStr);
      let bestIdx = 0;
      let bestDist = Infinity;
      for (let i = 0; i < currentImages.length; i++) {
        const dist = Math.abs(dateToNum(currentImages[i].date) - target);
        if (dist < bestDist) {
          bestDist = dist;
          bestIdx = i;
        }
      }
      setImageByIndex(bestIdx);
    }

    document.getElementById("btnFirst").addEventListener("click", () => setImageByIndex(0));
    document.getElementById("btnPrev").addEventListener("click", () => setImageByIndex(currentIndex - 1));
    document.getElementById("btnNext").addEventListener("click", () => setImageByIndex(currentIndex + 1));
    elDatePicker.addEventListener("change", (e) => {
      const v = e.target.value;
      if (!v) return;
      setImageByNearestDate(v);
    });

    function parseImageDate(file) {
      const match = file.match(/(\d{4}-\d{2}-\d{2})/);
      return match ? match[1] : "";
    }

    function buildImages(list) {
      const images = list
        .map(file => ({ file, date: parseImageDate(file) }))
        .filter(item => item.date);
      images.sort((a, b) => dateToNum(b.date) - dateToNum(a.date));
      return images;
    }

    function renderLocationList() {
      const list = document.getElementById("locationList");
      list.innerHTML = "";
      LOCATIONS.forEach(location => {
        const item = document.createElement("button");
        item.type = "button";
        item.className = `reservoir-item ${location.id === currentLocation.id ? "selected" : ""}`;
        item.innerHTML = `
          <div class="reservoir-top">
            <div>
              <div style="font-weight:700;">${location.label}</div>
              <div class="muted">${location.id === currentLocation.id ? "表示中" : "クリックで表示"}</div>
            </div>
            <span class="badge ok">${location.id === currentLocation.id ? "表示中" : "選択"}</span>
          </div>
        `;
        item.addEventListener("click", () => {
          if (currentLocation.id === location.id) return;
          currentLocation = location;
          currentImages = buildImages(location.images);
          currentIndex = 0;
          renderLocationList();
          setImageByIndex(0);
          loadAndRender();
        });
        list.appendChild(item);
      });
    }

    function buildCsvUrl() {
      return `${currentLocation.id}/data/timeseries_ndci_ndti_fai.csv`;
    }

    function initLocation() {
      currentLocation = LOCATIONS[0];
      currentImages = buildImages(currentLocation.images);
      renderLocationList();
      setImageByIndex(0);
    }

    // =========================
    // CSV -> Charts (Chart.js)
    // =========================
    function parseCSV(text) {
      // シンプルCSV想定（カンマ区切り、クォートや改行を含む複雑ケースは想定外）
      const lines = text.trim().split(/\r?\n/);
      const header = lines[0].split(",").map(s => s.trim());
      if (header.length && header[0].startsWith("\uFEFF")) {
        header[0] = header[0].replace("\uFEFF", "");
      }
      const rows = [];
      for (let i = 1; i < lines.length; i++) {
        if (!lines[i].trim()) continue;
        const cols = lines[i].split(",").map(s => s.trim());
        const obj = {};
        for (let j = 0; j < header.length; j++) obj[header[j]] = cols[j];
        rows.push(obj);
      }
      return { header, rows };
    }

    function toNumber(x) {
      const v = Number(x);
      return Number.isFinite(v) ? v : null;
    }

    let chartNdci, chartFai, chartNdti, chartSelected;

    function makeLineChart(canvasId, labels, data, yLabel, color = "#2563eb") {
      const ctx = document.getElementById(canvasId);
      return new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [{
            label: yLabel,
            data,
            pointRadius: 0,
            borderWidth: 2,
            tension: 0.2,
            borderColor: color
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true }
          },
          scales: {
            x: {
              ticks: { maxTicksLimit: 6 }
            },
            y: {
              title: { display: true, text: yLabel }
            }
          }
        }
      });
    }

    function formatValue(value) {
      if (value === null || value === undefined) return "—";
      return Number.isFinite(value) ? value.toFixed(4) : "—";
    }

    function renderSelectedChart(labels, series, metric) {
      const metricMap = {
        NDCI: {
          loess: series.ndciLoess,
          actual: series.ndci,
          color: "#2563eb"
        },
        NDTI: {
          loess: series.ndtiLoess,
          actual: series.ndti,
          color: "#0f766e"
        },
        FAI: {
          loess: series.faiLoess,
          actual: series.fai,
          color: "#7c3aed"
        }
      };
      const current = metricMap[metric];
      if (!current) return;

      if (chartSelected) chartSelected.destroy();
      const ctx = document.getElementById("chartSelected");
      chartSelected = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: `${metric}_mean_loess`,
              data: current.loess,
              pointRadius: 0,
              borderWidth: 2,
              tension: 0.2,
              borderColor: current.color
            },
            {
              label: `${metric}_mean (実測値)`,
              data: current.actual,
              pointRadius: 1,
              borderWidth: 1,
              tension: 0.1,
              borderColor: "#94a3b8",
              backgroundColor: "rgba(148,163,184,0.2)"
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: true } },
          scales: {
            x: { ticks: { maxTicksLimit: 6 } },
            y: { title: { display: true, text: `${metric} (loess + 実測)` } }
          }
        }
      });
    }

    async function loadAndRender() {
      try {
        const res = await fetch(buildCsvUrl(), { cache: "no-store" });
        if (!res.ok) throw new Error(`CSV fetch failed: ${res.status}`);
        const text = await res.text();
        const { rows } = parseCSV(text);

        // date 昇順に整列（念のため）
        rows.sort((a,b) => dateToNum(a.date) - dateToNum(b.date));

        const labels = rows.map(r => r.date);
        const ndci = rows.map(r => toNumber(r.NDCI_mean));
        const ndciLoess = rows.map(r => toNumber(r.NDCI_mean_loess));
        const ndti = rows.map(r => toNumber(r.NDTI_mean));
        const ndtiLoess = rows.map(r => toNumber(r.NDTI_mean_loess));
        const fai  = rows.map(r => toNumber(r.FAI_mean));
        const faiLoess = rows.map(r => toNumber(r.FAI_mean_loess));

        // 最新値（最後の行）
        const latest = rows[rows.length - 1];
        const latestDate = latest?.date ?? "—";

        document.getElementById("kpiNdci").textContent = formatValue(toNumber(latest?.NDCI_mean_loess));
        document.getElementById("kpiNdti").textContent = formatValue(toNumber(latest?.NDTI_mean_loess));
        document.getElementById("kpiFai").textContent  = formatValue(toNumber(latest?.FAI_mean_loess));

        document.getElementById("kpiDate").textContent  = `latest: ${latestDate}`;
        document.getElementById("kpiDate2").textContent = `latest: ${latestDate}`;
        document.getElementById("kpiDate3").textContent = `latest: ${latestDate}`;

        // 既存チャートがあれば破棄
        if (chartNdci) chartNdci.destroy();
        if (chartFai) chartFai.destroy();
        if (chartNdti) chartNdti.destroy();

        chartNdci = makeLineChart("chartNdci", labels, ndciLoess, "NDCI_mean_loess", "#2563eb");
        chartNdti = makeLineChart("chartNdti", labels, ndtiLoess, "NDTI_mean_loess", "#0f766e");
        chartFai  = makeLineChart("chartFai",  labels, faiLoess,  "FAI_mean_loess", "#7c3aed");

        const metricSelect = document.getElementById("metricSelect");
        renderSelectedChart(labels, { ndci, ndciLoess, ndti, ndtiLoess, fai, faiLoess }, metricSelect.value);
        metricSelect.onchange = () => {
          renderSelectedChart(labels, { ndci, ndciLoess, ndti, ndtiLoess, fai, faiLoess }, metricSelect.value);
        };

      } catch (err) {
        console.error(err);
        document.getElementById("kpiNdci").textContent = "CSV読込失敗";
        document.getElementById("kpiFai").textContent  = "CSV読込失敗";
        document.getElementById("kpiNdti").textContent = "CSV読込失敗";
      }
    }

    initLocation();
    loadAndRender();
  </script>
</body>
</html>
